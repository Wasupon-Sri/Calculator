<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Calcium Calculator</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to enhance Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom focus ring for better accessibility and aesthetics */
        .form-input-custom:focus {
            outline: none;
            border-color: #22d3ee; /* cyan-400 */
            box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.3);
        }

        /* Style for the input field that shows the result */
        .calculated-field {
            background-color: #164e63; /* cyan-800 */
            color: #ecfeff; /* cyan-50 */
            font-weight: 600;
            border-color: #67e8f9; /* cyan-300 */
            box-shadow: 0 0 10px rgba(103, 232, 249, 0.4);
        }

        /* Custom scrollbar for a more modern feel */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="bg-slate-900 flex items-center justify-center min-h-screen p-4 text-slate-300">

    <div class="w-full max-w-2xl bg-slate-800 rounded-2xl shadow-2xl shadow-cyan-500/10 border border-slate-700 p-6 md:p-8 space-y-8">
        
        <header class="text-center flex flex-col items-center gap-2">
            <!-- High-tech icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                <path d="m12 14-4-2 4-2 4 2-4 2z"></path>
                <path d="M12 22V12"></path>
                <path d="M8 12v-2"></path>
                <path d="M16 12v-2"></path>
            </svg>
            <h1 class="text-2xl md:text-3xl font-bold text-slate-100">Clinical Calcium Calculator</h1>
            <p class="text-slate-400 mt-1 text-sm">For medical professional use</p>
        </header>

        <!-- Error Message Box -->
        <div id="errorMessage" class="hidden p-4 text-sm text-red-400 rounded-lg bg-red-900/40 border border-red-500/50" role="alert">
            <span class="font-bold">Error:</span> <span id="errorMessageText"></span>
        </div>

        <!-- Corrected Calcium Calculator -->
        <section class="space-y-4">
            <h2 class="text-lg font-semibold text-cyan-400 border-b border-slate-700 pb-2">Corrected Calcium (cCa)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="totalCalcium" class="block text-sm font-medium text-slate-400 mb-1">Total Calcium (mg/dL)</label>
                    <input type="number" id="totalCalcium" placeholder="e.g., 8.5" class="form-input-custom w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm transition text-white">
                </div>
                <div>
                    <label for="albumin" class="block text-sm font-medium text-slate-400 mb-1">Albumin (g/dL)</label>
                    <input type="number" id="albumin" placeholder="e.g., 3.0" class="form-input-custom w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm transition text-white">
                </div>
            </div>
            <button onclick="calculateCorrectedCalcium()" class="w-full bg-cyan-600 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-cyan-700 focus:outline-none focus:ring-4 focus:ring-cyan-500/50 transition-all duration-200 shadow-lg shadow-cyan-600/20">
                Calculate cCa
            </button>
            <div id="correctedCalciumResult" class="hidden mt-4 text-center p-3 bg-slate-700/50 border-l-4 border-cyan-500 rounded-r-lg">
                <p class="text-cyan-300 font-semibold text-lg"></p>
            </div>
        </section>

        <!-- Calcium Infusion Rate Calculator -->
        <section class="space-y-4">
            <h2 class="text-lg font-semibold text-cyan-400 border-b border-slate-700 pb-2">Calcium Gluconate Infusion</h2>
            <p class="text-sm text-slate-500 mb-4 -mt-2">Fill all other fields, then click "Calc" for the one you need.</p>

            <div id="infusionCalc" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <!-- Rate -->
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <label for="infusion_rate" class="text-sm font-medium text-slate-400">Infusion Rate (mg/kg/hr)</label>
                        <button onclick="calculateInfusion('rate')" class="bg-slate-700 hover:bg-slate-600 text-cyan-400 text-xs font-semibold py-1 px-3 rounded-full transition-colors">Calc</button>
                    </div>
                    <input type="number" id="infusion_rate" placeholder="e.g., 1.5" class="form-input-custom w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm transition text-white">
                </div>
                <!-- Weight -->
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <label for="infusion_weight" class="text-sm font-medium text-slate-400">Patient Weight (kg)</label>
                        <button onclick="calculateInfusion('weight')" class="bg-slate-700 hover:bg-slate-600 text-cyan-400 text-xs font-semibold py-1 px-3 rounded-full transition-colors">Calc</button>
                    </div>
                    <input type="number" id="infusion_weight" placeholder="e.g., 70" class="form-input-custom w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm transition text-white">
                </div>
                <!-- Ca Gluconate -->
                <div>
                    <div class="flex items-center justify-between mb-1">
                       <label for="infusion_caVolume" class="text-sm font-medium text-slate-400">10% Ca Gluconate (mL)</label>
                       <button onclick="calculateInfusion('caVolume')" class="bg-slate-700 hover:bg-slate-600 text-cyan-400 text-xs font-semibold py-1 px-3 rounded-full transition-colors">Calc</button>
                    </div>
                    <input type="number" id="infusion_caVolume" class="form-input-custom w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm transition text-white" placeholder="e.g., 100">
                </div>
                <!-- Diluent Volume -->
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <label for="infusion_ivVolume" class="text-sm font-medium text-slate-400">Diluent Volume (mL)</label>
                        <button onclick="calculateInfusion('ivVolume')" class="bg-slate-700 hover:bg-slate-600 text-cyan-400 text-xs font-semibold py-1 px-3 rounded-full transition-colors">Calc</button>
                    </div>
                    <input type="number" id="infusion_ivVolume" placeholder="e.g., 900" class="form-input-custom w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm transition text-white">
                </div>
                 <!-- Total Fluid Volume -->
                <div>
                     <div class="flex items-center justify-between mb-1">
                        <label for="infusion_totalVolume" class="text-sm font-medium text-slate-400">Total Fluid Volume (mL)</label>
                    </div>
                    <input type="number" id="infusion_totalVolume" placeholder="Auto-calculated" class="form-input-custom w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm transition text-white">
                </div>
                <!-- Drip Rate -->
                <div>
                     <div class="flex items-center justify-between mb-1">
                        <label for="infusion_dripRate" class="text-sm font-medium text-slate-400">IV Drip Rate (mL/hr)</label>
                        <button onclick="calculateInfusion('dripRate')" class="bg-slate-700 hover:bg-slate-600 text-cyan-400 text-xs font-semibold py-1 px-3 rounded-full transition-colors">Calc</button>
                    </div>
                    <input type="number" id="infusion_dripRate" placeholder="e.g., 50" class="form-input-custom w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm transition text-white">
                </div>
            </div>
        </section>
        
        <!-- Toggle Button for Duration Section -->
        <div class="text-center pt-2">
            <button id="toggleDurationBtn" onclick="toggleDurationSection()" class="text-sm text-cyan-500 hover:text-cyan-400 font-medium transition">
                Show Infusion Duration Calculator
            </button>
        </div>

        <!-- Infusion Duration Calculator (hidden by default) -->
        <section id="durationSection" class="hidden transition-all duration-500">
             <h2 class="text-lg font-semibold text-cyan-400 border-b border-slate-700 pb-2 mb-4">Infusion Duration</h2>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                 <div>
                    <div class="flex items-center justify-between mb-1">
                         <label for="duration_totalVolume" class="text-sm font-medium text-slate-400">Total Volume (mL)</label>
                         <button onclick="calculateDuration('totalVolume')" class="bg-slate-700 hover:bg-slate-600 text-cyan-400 text-xs font-semibold py-1 px-3 rounded-full transition-colors">Calc</button>
                    </div>
                    <input type="number" id="duration_totalVolume" class="form-input-custom w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm transition text-white" placeholder="Value from above">
                 </div>
                 <div>
                      <div class="flex items-center justify-between mb-1">
                           <label for="duration_dripRate" class="text-sm font-medium text-slate-400">Drip Rate (mL/hr)</label>
                           <button onclick="calculateDuration('dripRate')" class="bg-slate-700 hover:bg-slate-600 text-cyan-400 text-xs font-semibold py-1 px-3 rounded-full transition-colors">Calc</button>
                      </div>
                      <input type="number" id="duration_dripRate" class="form-input-custom w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm transition text-white" placeholder="Value from above">
                 </div>
                 <div>
                      <div class="flex items-center justify-between mb-1">
                           <label for="duration_time" class="text-sm font-medium text-slate-400">Time (hours)</label>
                           <button onclick="calculateDuration('time')" class="bg-slate-700 hover:bg-slate-600 text-cyan-400 text-xs font-semibold py-1 px-3 rounded-full transition-colors">Calc</button>
                      </div>
                      <input type="number" id="duration_time" class="form-input-custom w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm transition text-white" placeholder="e.g., 20">
                 </div>
             </div>
        </section>

    </div>

    <script>
    // --- START: UNCHANGED JAVASCRIPT LOGIC ---
    const ELEMENTAL_CA_IN_GLUCONATE = 9.3; // mg per mL of 10% solution
    
    // --- Utility Functions ---
    const errorMessageDiv = document.getElementById('errorMessage');
    const errorMessageText = document.getElementById('errorMessageText');

    function showError(message) {
        errorMessageText.textContent = message;
        errorMessageDiv.classList.remove('hidden');
    }

    function hideError() {
        errorMessageDiv.classList.add('hidden');
    }

    // --- Corrected Calcium ---
    function calculateCorrectedCalcium() {
        hideError();
        const totalCa = parseFloat(document.getElementById('totalCalcium').value);
        const albumin = parseFloat(document.getElementById('albumin').value);
        const resultDiv = document.getElementById('correctedCalciumResult');
        const resultP = resultDiv.querySelector('p');

        if (isNaN(totalCa) || isNaN(albumin)) {
            showError("Please enter valid numbers for both Total Calcium and Albumin.");
            resultDiv.classList.add('hidden');
            return;
        }

        const correctedCa = totalCa + (0.8 * (4.0 - albumin));
        resultP.innerHTML = `Corrected Calcium: <span class="font-bold text-white">${correctedCa.toFixed(2)} mg/dL</span>`;
        resultDiv.classList.remove('hidden');
    }

    // --- Infusion Calculations ---
    const infusionInputs = {
        rate: document.getElementById('infusion_rate'),
        weight: document.getElementById('infusion_weight'),
        caVolume: document.getElementById('infusion_caVolume'),
        ivVolume: document.getElementById('infusion_ivVolume'),
        totalVolume: document.getElementById('infusion_totalVolume'),
        dripRate: document.getElementById('infusion_dripRate')
    };
    
    // --- Duration Calculations ---
    const durationInputs = {
        totalVolume: document.getElementById('duration_totalVolume'),
        dripRate: document.getElementById('duration_dripRate'),
        time: document.getElementById('duration_time')
    };

    // --- Event Listeners for Input Syncing and Auto-Calculation ---
    function setupEventListeners() {
        // Volume auto-calculation logic
        ['caVolume', 'ivVolume', 'totalVolume'].forEach(key => {
            infusionInputs[key].addEventListener('input', () => handleVolumeChange(infusionInputs[key]));
        });

        // Sync main inputs TO duration inputs
        infusionInputs.totalVolume.addEventListener('input', () => durationInputs.totalVolume.value = infusionInputs.totalVolume.value);
        infusionInputs.dripRate.addEventListener('input', () => durationInputs.dripRate.value = infusionInputs.dripRate.value);

        // Sync duration inputs TO main inputs
        durationInputs.totalVolume.addEventListener('input', () => {
            infusionInputs.totalVolume.value = durationInputs.totalVolume.value;
            handleVolumeChange(infusionInputs.totalVolume); // Recalculate diluent if total changes
        });
        durationInputs.dripRate.addEventListener('input', () => infusionInputs.dripRate.value = durationInputs.dripRate.value);
    }
    setupEventListeners();

    function handleVolumeChange(changedElement) {
        const caVolume = parseFloat(infusionInputs.caVolume.value);
        const ivVolume = parseFloat(infusionInputs.ivVolume.value);
        const totalVolume = parseFloat(infusionInputs.totalVolume.value);

        if (changedElement === infusionInputs.caVolume || changedElement === infusionInputs.ivVolume) {
            if (!isNaN(caVolume) && !isNaN(ivVolume)) {
                const newTotal = caVolume + ivVolume;
                infusionInputs.totalVolume.value = newTotal > 0 ? newTotal.toFixed(2) : '';
                durationInputs.totalVolume.value = infusionInputs.totalVolume.value; // Sync
            }
        } else if (changedElement === infusionInputs.totalVolume) {
            if (!isNaN(totalVolume) && !isNaN(caVolume) && totalVolume >= caVolume) {
                 const newDiluent = totalVolume - caVolume;
                 infusionInputs.ivVolume.value = newDiluent >= 0 ? newDiluent.toFixed(2) : '';
            }
        }
    }

    function calculateInfusion(targetKey) {
        hideError();
        let filledValues = {};

        for (const key in infusionInputs) {
            infusionInputs[key].classList.remove('calculated-field');
            if (key !== targetKey) {
                const value = infusionInputs[key].value;
                filledValues[key] = value === '' ? NaN : parseFloat(value);
            }
        }
        
        const targetInput = infusionInputs[targetKey];
        let result = NaN;

        try {
            const { rate, weight, caVolume, ivVolume, dripRate } = filledValues;
            let totalVolume = filledValues.totalVolume;

            if (isNaN(totalVolume)) {
                if (!isNaN(caVolume) && !isNaN(ivVolume)) {
                    totalVolume = caVolume + ivVolume;
                }
            }
            
            if (targetKey !== 'totalVolume' && isNaN(totalVolume)) {
                showError("Please provide enough volume information (e.g., Ca Gluconate and Diluent)."); return;
            }

            switch (targetKey) {
                case 'rate':
                    if (isNaN(weight) || isNaN(dripRate) || isNaN(caVolume)) { showError("Provide Weight, Drip Rate, Ca Gluconate, and volume info."); return; }
                    if (weight <= 0 || totalVolume <= 0) { showError("Weight and total volume must be positive."); return; };
                    result = ((caVolume * ELEMENTAL_CA_IN_GLUCONATE) / totalVolume * dripRate) / weight;
                    break;
                case 'dripRate':
                    if (isNaN(rate) || isNaN(weight) || isNaN(caVolume)) { showError("Provide Rate, Weight, Ca Gluconate, and volume info."); return; }
                    if (weight <= 0 || caVolume <= 0) { showError("Weight and Ca Gluconate volume must be positive."); return; };
                    result = (rate * weight * totalVolume) / (caVolume * ELEMENTAL_CA_IN_GLUCONATE);
                    break;
                case 'ivVolume':
                    if (isNaN(rate) || isNaN(weight) || isNaN(dripRate) || isNaN(caVolume)) { showError("Provide Rate, Weight, Drip Rate, and Ca Gluconate Volume."); return; }
                    if (rate <= 0 || weight <= 0 || dripRate <= 0) { showError("Rate, Weight, and Drip Rate must be positive."); return; };
                    const requiredTotalVol = (caVolume * ELEMENTAL_CA_IN_GLUCONATE * dripRate) / (rate * weight);
                    result = requiredTotalVol - caVolume;
                    break;
                case 'caVolume':
                    if (isNaN(rate) || isNaN(weight) || isNaN(dripRate)) { showError("Provide Rate, Weight, Drip Rate, and volume info."); return; }
                    if (rate <= 0 || weight <= 0 || dripRate <= 0) { showError("Rate, Weight, and Drip Rate must be positive."); return; };
                    result = (rate * weight * totalVolume) / (ELEMENTAL_CA_IN_GLUCONATE * dripRate);
                    break;
                case 'weight':
                    if (isNaN(rate) || isNaN(dripRate) || isNaN(caVolume)) { showError("Provide Rate, Drip Rate, Ca Gluconate, and volume info."); return; }
                    if (rate <= 0 || totalVolume <= 0) { showError("Rate and total volume must be positive."); return; };
                    result = ((caVolume * ELEMENTAL_CA_IN_GLUCONATE) / totalVolume * dripRate) / rate;
                    break;
            }

            if (isNaN(result) || !isFinite(result) || result < 0) {
                showError("Calculation resulted in an invalid number. Please check your inputs.");
                return;
            }
            
            targetInput.value = result.toFixed(2);
            targetInput.classList.add('calculated-field');
            
            // Trigger updates if a volume or rate was calculated
            if (targetKey === 'ivVolume' || targetKey === 'caVolume') {
                handleVolumeChange(targetInput);
            }
             if (targetKey === 'dripRate') {
                durationInputs.dripRate.value = targetInput.value;
            }

        } catch (error) {
            showError(error.message);
            targetInput.value = '';
        }
    }

    // --- New Duration Functions ---
    function toggleDurationSection() {
        const section = document.getElementById('durationSection');
        const btn = document.getElementById('toggleDurationBtn');
        const isHidden = section.classList.contains('hidden');
        
        if (isHidden) {
            section.classList.remove('hidden');
            btn.textContent = 'Hide Infusion Duration Calculator';
        } else {
            section.classList.add('hidden');
            btn.textContent = 'Show Infusion Duration Calculator';
        }
    }

    function calculateDuration(targetKey) {
        hideError();
        for (const key in durationInputs) {
            durationInputs[key].classList.remove('calculated-field');
        }

        const totalVolume = parseFloat(durationInputs.totalVolume.value);
        const dripRate = parseFloat(durationInputs.dripRate.value);
        const time = parseFloat(durationInputs.time.value);
        const targetInput = durationInputs[targetKey];
        let result = NaN;

        try {
            switch (targetKey) {
                case 'time':
                    if (isNaN(totalVolume) || isNaN(dripRate)) { showError("Provide Total Volume and Drip Rate."); return; }
                    if (dripRate <= 0) { showError("Drip Rate must be positive."); return; }
                    result = totalVolume / dripRate;
                    break;
                case 'dripRate':
                    if (isNaN(totalVolume) || isNaN(time)) { showError("Provide Total Volume and Time."); return; }
                    if (time <= 0) { showError("Time must be positive."); return; }
                    result = totalVolume / time;
                    break;
                case 'totalVolume':
                    if (isNaN(dripRate) || isNaN(time)) { showError("Provide Drip Rate and Time."); return; }
                    result = dripRate * time;
                    break;
            }

            if (isNaN(result) || !isFinite(result) || result < 0) {
                showError("Calculation resulted in an invalid number. Check inputs."); return;
            }

            targetInput.value = result.toFixed(2);
            targetInput.classList.add('calculated-field');

            // Sync result back to the main calculator
            if (targetKey === 'dripRate' || targetKey === 'totalVolume') {
                infusionInputs[targetKey].value = targetInput.value;
                if(targetKey === 'totalVolume') handleVolumeChange(infusionInputs.totalVolume);
            }

        } catch(e) {
            showError(e.message);
        }
    }
    // --- END: UNCHANGED JAVASCRIPT LOGIC ---
</script>

</body>
</html>
